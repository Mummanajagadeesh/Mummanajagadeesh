name: Update README with Repo Cards

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"  # Daily at 12:00 UTC

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch all public repositories
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_GH_TOKEN }}
        run: |
          curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/users/Mummanajagadeesh/repos?per_page=100&type=public" > all_repos.json

      - name: Generate repo cards
        run: |
          mkdir -p repos
          echo "<!--START:REPO_CARDS-->" > insert.txt

          get_color() {
            case "$1" in
              Verilog) echo "#f1e05a" ;;
              Python) echo "#3572A5" ;;
              Roff) echo "#ecdebe" ;;
              HTML) echo "#e34c26" ;;
              V) echo "#b2b7f8" ;;
              *) echo "#cccccc" ;;
            esac
          }

          generate_svg() {
            THEME=$1
            FILE=$2
            BG_COLOR=$3
            BORDER_COLOR=$4
            NAME_COLOR=$5
            DESC_COLOR=$6
            META_COLOR=$7
            BADGE_FILL=$8
            BADGE_STROKE=$9

            echo "<svg width=\"500\" height=\"140\" viewBox=\"0 0 500 140\" xmlns=\"http://www.w3.org/2000/svg\">" > $FILE
            echo "  <style>" >> $FILE
            echo "    .card-bg { fill: $BG_COLOR; stroke: $BORDER_COLOR; stroke-width: 1; }" >> $FILE
            echo "    .repo-name { font: bold 16px sans-serif; fill: $NAME_COLOR; cursor: pointer; }" >> $FILE
            echo "    .repo-desc { font: 14px sans-serif; fill: $DESC_COLOR; }" >> $FILE
            echo "    .meta { font: 12px sans-serif; fill: $META_COLOR; }" >> $FILE
            echo "    .badge { font: 11px sans-serif; fill: $META_COLOR; }" >> $FILE
            echo "    .lang-dot { r: 5; }" >> $FILE
            echo "  </style>" >> $FILE
            echo "  <rect class=\"card-bg\" x=\"0\" y=\"0\" width=\"500\" height=\"140\" rx=\"12\" ry=\"12\" />" >> $FILE
            echo "  <a href=\"https://github.com/Mummanajagadeesh/$NAME\" target=\"_blank\">" >> $FILE
            echo "    <text x=\"16\" y=\"30\" class=\"repo-name\">$NAME</text>" >> $FILE
            echo "  </a>" >> $FILE

            if [ "$PRIVATE" = "true" ]; then
              echo "  <rect x=\"100\" y=\"16\" rx=\"4\" ry=\"4\" width=\"65\" height=\"18\" fill=\"$BADGE_FILL\" stroke=\"$BADGE_STROKE\" />" >> $FILE
              echo "  <text x=\"108\" y=\"29\" class=\"badge\">Private</text>" >> $FILE
            fi

            echo "  <text x=\"16\" y=\"55\" class=\"repo-desc\">$DESC</text>" >> $FILE

            X=16
            for LANG in $LANGS; do
              COLOR=$(get_color "$LANG")
              echo "  <circle class=\"lang-dot\" cx=\"$X\" cy=\"80\" fill=\"$COLOR\" />" >> $FILE
              echo "  <text x=\"$((X+10))\" y=\"84\" class=\"meta\">$LANG</text>" >> $FILE
              X=$((X + 75))
            done

            echo "  <text x=\"16\" y=\"110\" class=\"meta\">‚≠ê $STARS star(s)</text>" >> $FILE
            echo "</svg>" >> $FILE
          }

          for row in $(jq -r '.[] | @base64' all_repos.json); do
            _jq() {
              echo "${row}" | base64 --decode | jq -r "${1}"
            }

            NAME=$(_jq '.name')
            DESC=$(_jq '.description')
            PRIVATE=$(_jq '.private')
            STARS=$(_jq '.stargazers_count')

            if [ "$DESC" = "null" ]; then DESC="No description provided"; fi

            LANGS=$(curl -s "https://api.github.com/repos/Mummanajagadeesh/$NAME/languages" | jq -r 'keys_unsorted[]')

            generate_svg light "repos/${NAME,,}-light.svg" "#fff" "#1f6feb" "#0969da" "#57606a" "#57606a" "#ddf4ff" "#0969da"
            generate_svg dark "repos/${NAME,,}-dark.svg" "#0d1117" "#1f6feb" "#58a6ff" "#8b949e" "#8b949e" "#1f6feb1a" "#388bfd"

            echo "" >> insert.txt
            echo "<a href=\"https://github.com/Mummanajagadeesh#gh-light-mode-only\">" >> insert.txt
            echo "  <img src=\"./repos/${NAME,,}-light.svg#gh-light-mode-only\" alt=\"$NAME (light mode)\" />" >> insert.txt
            echo "</a>" >> insert.txt
            echo "<a href=\"https://github.com/Mummanajagadeesh#gh-dark-mode-only\">" >> insert.txt
            echo "  <img src=\"./repos/${NAME,,}-dark.svg#gh-dark-mode-only\" alt=\"$NAME (dark mode)\" />" >> insert.txt
            echo "</a>" >> insert.txt
            echo "" >> insert.txt

            # Per-repo section
            sed -i "/<!--START-REPO-CARD:$NAME-->/,/<!--END-REPO-CARD:$NAME-->/c\\
<!--START-REPO-CARD:$NAME-->\n\
<a href=\"https://github.com/Mummanajagadeesh#gh-light-mode-only\">\n\
  <img src=\"./repos/${NAME,,}-light.svg#gh-light-mode-only\" alt=\"$NAME (light mode)\" />\n\
</a>\n\
<a href=\"https://github.com/Mummanajagadeesh#gh-dark-mode-only\">\n\
  <img src=\"./repos/${NAME,,}-dark.svg#gh-dark-mode-only\" alt=\"$NAME (dark mode)\" />\n\
</a>\n\
<!--END-REPO-CARD:$NAME-->" README.md

          done

          echo "<!--END:REPO_CARDS-->" >> insert.txt

      - name: Update README.md
        run: |
          awk '/<!--START:REPO_CARDS-->/ {print; system("tail -n +2 insert.txt | head -n -1"); found=1; next}
               /<!--END:REPO_CARDS-->/ {found=0}
               !found {print}' README.md > README.tmp
          mv README.tmp README.md

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md repos/
          git commit -m "Update README with dynamic repo cards" || echo "No changes to commit"
          git push
